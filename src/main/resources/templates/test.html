<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>极简 Hash + 进度</title>
</head>
<body>

<h3>请选择文件：</h3>
<input id="file" type="file">

<p>进度：<span id="progress">0%</span></p>
<p>最终文件 hash：<span id="hash">-</span></p>

<script>
    const fileInput = document.getElementById('file');
    const progressSpan = document.getElementById('progress');
    const hashSpan = document.getElementById('hash');

    const chunkSize = 1024 * 1024;
    const worker = new Worker('/libs/worker.js');

    let totalChunks = 0;
    let receivedChunks = 0;

    worker.onmessage = function (e) {
        const data = e.data;

        if (data.type === 'progress') {
            receivedChunks++;
            const percent = Math.floor((receivedChunks / totalChunks) * 100);
            progressSpan.textContent = percent + '%';
        }

        if (data.type === 'final') {
            hashSpan.textContent = data.finalHash;
        }
    };

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        totalChunks = Math.ceil(file.size / chunkSize);
        receivedChunks = 0;

        progressSpan.textContent = '0%';
        hashSpan.textContent = '-';

        worker.postMessage({ type: 'init', total: totalChunks });

        for (let i = 0; i < totalChunks; i++) {
            const start = i * chunkSize;
            const end = Math.min(start + chunkSize, file.size);
            const chunk = file.slice(start, end);

            chunk.arrayBuffer().then(buffer => {
                if (buffer instanceof ArrayBuffer) {
                    worker.postMessage({ type: 'chunk', index: i, buffer }, [buffer]);
                } else {
                    worker.postMessage({ type: 'chunk', index: i, buffer });
                }
            });
        }
    });
</script>

</body>
</html>
