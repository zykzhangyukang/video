<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>极简 Hash + 进度</title>
</head>
<body>

<h3>请选择文件：</h3>
<input id="file" type="file">

<script>
    const fileInput = document.getElementById('file');


    async function cutFile(file) {
        const CHUNK_SIZE = 1024 * 1024;
        return new Promise(resolve => {
            const chunkCount = Math.ceil(file.size / CHUNK_SIZE);
            const threadChunkCount = Math.ceil(chunkCount / (navigator.hardwareConcurrency || 4));
            const result = [];
            let finishCount = 0;

            for (let i = 0; i < (navigator.hardwareConcurrency || 4); i++) {
                const worker = new Worker('/libs/worker.js');
                const start = i * threadChunkCount;
                let end = (i + 1) * threadChunkCount;

                if (end > chunkCount) {
                    end = chunkCount;
                }

                worker.postMessage({
                    file,
                    CHUNK_SIZE,
                    startChunkIndex: start,
                    endChunkIndex: end
                });

                worker.onmessage = e => {
                    for (let j = start; j < end; j++) {
                        result[j] = e.data[j - start];
                    }
                    worker.terminate();
                    finishCount++;

                    if (finishCount === (navigator.hardwareConcurrency || 4)) {
                        resolve(result);
                    }
                };
            }
        });
    }

    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        console.log('开始切片...');
        try {
            const chunks = await cutFile(file);
            console.log('切片完成：', chunks);

            // 可选：展示切片进度或结果
            chunks.forEach((chunk, index) => {
                console.log(`Chunk ${index}:`, chunk);
            });
        } catch (err) {
            console.error('切片失败：', err);
        }
    });



</script>

</body>
</html>
