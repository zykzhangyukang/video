<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>极简 Hash + 进度</title>
</head>
<body>

<h3>请选择文件：</h3>
<input id="file" type="file">

<script th:src="@{/libs/spark-md5.min.js}"></script>
<script th:src="@{/libs/axios.min.js}"></script>
<script>
    const fileInput = document.getElementById('file');
    const CHUNK_SIZE = 1024 * 1024;

    async function cutFile(file) {
        return new Promise(resolve => {
            const chunkCount = Math.ceil(file.size / CHUNK_SIZE);
            const threadChunkCount = Math.ceil(chunkCount / (navigator.hardwareConcurrency || 4));
            const result = [];
            let finishCount = 0;

            for (let i = 0; i < (navigator.hardwareConcurrency || 4); i++) {
                const worker = new Worker('/libs/worker.js');
                const start = i * threadChunkCount;
                let end = (i + 1) * threadChunkCount;

                if (end > chunkCount) {
                    end = chunkCount;
                }

                worker.postMessage({
                    file,
                    CHUNK_SIZE,
                    startChunkIndex: start,
                    endChunkIndex: end
                });

                worker.onmessage = e => {
                    for (let j = start; j < end; j++) {
                        result[j] = e.data[j - start];
                    }
                    worker.terminate();
                    finishCount++;

                    if (finishCount === (navigator.hardwareConcurrency || 4)) {
                        resolve(result);
                    }
                };
            }
        });
    }

    async function computeFileHash(chunkList){
        const spark = new SparkMD5();
        for (let chunk of chunkList) {
            spark.append(chunk.hash);
        }
        return spark.end();
    }

    async function _getUploadId(file, fileHash, totalParts) {
        try {
            const response = await axios.post('/api/upload/init', {
                fileName: file.name,
                fileSize: file.size,
                fileHash,
                totalParts
            });
            return response.data;
        } catch (error) {
            console.error('请求 uploadId 失败：', error);
            throw error;
        }
    }


    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
            const chunks = await cutFile(file);
            let fileHash = await this.computeFileHash(chunks);
            const {result: { uploadId, startPart, isSkip, filePath }} = await this._getUploadId(file, fileHash, chunks.length);

            chunks.for(item=>{

                // 一片一片上传

            })

        } catch (err) {
            console.error('切片失败：', err);
        }
    });

</script>

</body>
</html>
