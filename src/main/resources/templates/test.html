<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>极简 Hash + 进度</title>
</head>
<body>

<input id="file" type="file"> 进度：xxx

<script>
    const fileInput = document.getElementById('file');
    const chunkSize = 1024 * 1024; // 1MB
    const worker = new Worker('/libs/worker.js');

    let totalChunks = 0;
    let receivedChunks = 0;

    worker.onmessage = function (e) {
        const data = e.data;

        if (data.type === 'progress') {
            receivedChunks++;
            const percent = Math.floor((receivedChunks / totalChunks) * 100);
            console.log(`进度：${percent}%`);
        }

        if (data.type === 'final') {
            console.log('最终文件 hash：', data.finalHash);
        }
    };

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        totalChunks = Math.ceil(file.size / chunkSize);
        receivedChunks = 0;

        worker.postMessage({ type: 'init', total: totalChunks });

        for (let i = 0; i < totalChunks; i++) {
            const start = i * chunkSize;
            const end = Math.min(start + chunkSize, file.size);
            const chunk = file.slice(start, end);

            chunk.arrayBuffer().then(buffer => {
                if (buffer instanceof ArrayBuffer) {
                    worker.postMessage({ type: 'chunk', index: i, buffer }, [buffer]);
                } else {
                    worker.postMessage({ type: 'chunk', index: i, buffer });
                }
            });
        }
    });
</script>

</body>
</html>
